# d3bdd

非常好的一道题，了解了不少新东西，如果不是商环没选好的原因，难度还是比较高的

官方wp，shallow写的十分详尽了

赛后复现一下预期解法，这里我把多项式环 $R$ 改成了 $\frac{Z_q[x]}{x^{512}+1}$ ，这样就不能通过分解商多项式在较低维度上求解ideal lattice了

```python
    def __mul__(self , other):
        assert type(other) == polynomial
        res = [0]*n
        for i in range(n):
            for j in range(n):
                if i+j<n:
                    res[(i+j)] += self.f[i] * other.f[j]
                    res[(i+j)] %= q
                else:
                    res[(i + j) % n] += -self.f[i] * other.f[j]
                    res[(i + j) % n] %= q
        return polynomial(res)
```

**Dual Attack**

![image-20230507114131857](../AppData/Roaming/Typora/typora-user-images/image-20230507114131857.png)

这个点在hint中已经给到了，而dual attack能否成功，一个重要的点在于能否找到合适的$x_j^T$，也就是能否有效约减dual lattice

***Solution***

bdd这题是rlwe，所以需要求解一个理想格对应的约减对偶格，在这题里其实就是正交格

正常来说求一个高维格的约化基效果是比较差的，但是这里题目使用的是特殊的lcg进行格的生成

将A写成矩阵的形式
$$
\left[\begin{matrix}
a_{511}&a_{510}&\cdots&a_{1}&a_{0}\\
a_{510}&a_{509}&\cdots&a_0&-a_{511}\\
\vdots&\vdots&\vdots&\ddots&\vdots\\
a_{0}&-a_{511}&\cdots&-a_{2}&-a_{1}
\end{matrix}\right]
$$

对于LCG，有 $\sum_{i=0}^{15}f_ia_{k+i}-a_{k+16}=0(mod~m)~~(*)$

我们利用$(*)$构造lattice去重组系数，最后选择了利用连续80个$a_i$构造多项式 $t$ ，这需要我们舍弃掉A中的部分行，以满足 $t*A'=0(mod~m)$，这需要根据最后选择枚举的位置去舍弃

由于rlwe的计算在 $Z_q$ 下，有等式 $t*A'=m*v$ ，其中v的模长比较小，构造格求系数g使 $g*m$ 足够小，粗略是 $\sqrt{q}$ 的量级

这样我们可以利用以下步骤验证爆破的正确性

$A=[A'|A'']$  $s=[s'|s'']$

$A*s+e=b(mod~q)$

$g*m*v*s'+g*t*e=g*t*A'*s'+g*t*e=g*t*(b-A''*s'')(mod~q)$

左边的量级为 $\sqrt{q}*||v||*||s||+\sqrt{q}*||t||*||e||$

现在我们爆破 $s''$，如果正确，上式左边的结果会较小，否则将趋于 $\frac{q}{2}$ 的数量级

***Exp***

```python
from tqdm import tqdm

b = [368964263, 2549845494, 2117526493, 441931181, 2149041847, 1710610480, 199597543, 1030119815, 3953035967, 4083522684, 2189941227, 3725639939, 3994268995, 2255736398, 831110696, 3148446494, 596785981, 2728723542, 4037493967, 1021467666, 3519718228, 953142007, 3471557553, 3022848436, 2684247379, 331269525, 3656982924, 866571374, 4033804441, 2906956502, 1496219238, 1257111829, 862945519, 3907192531, 2012270383, 2784318387, 3239805041, 2823117595, 788559186, 694522873, 703701269, 4141245668, 2697153415, 3016917824, 3402454896, 3232353990, 1138017453, 2185895278, 914830123, 2814456887, 3476893153, 3349196750, 2141729851, 3682416864, 1719435808, 2520235123, 2790984612, 1984791499, 2453885299, 2018484764, 1102489481, 3491332840, 929032766, 1834505275, 4241966695, 461715922, 1942897780, 2820447760, 3994081535, 1067827929, 1003627353, 1175109770, 1693788072, 3379188020, 3384181960, 2873904251, 937901493, 3379068806, 143321330, 3238745699, 3138735655, 340317635, 930830436, 3603490208, 3553477581, 431830242, 2096734957, 2733319083, 4243662481, 2171142619, 268713662, 2217709490, 3297536706, 2619677781, 3643033885, 2168114784, 1944633618, 3672414756, 1948731671, 775826162, 1846895774, 2963221004, 2707560094, 811509447, 1883284929, 1234689602, 329810316, 1015889321, 1969454295, 2485367905, 2086566809, 3628192974, 1123263141, 1339403859, 1020420603, 2156066373, 2811139678, 2624429489, 2901404509, 4073796539, 2837099705, 907593457, 2337090879, 4257221736, 3710051348, 1980635151, 462599992, 1342590133, 3098557880, 2864271097, 1624208227, 1429207923, 404159795, 3004751432, 4214727604, 3218223837, 2533865867, 1085916736, 126381855, 1125203206, 4210284576, 1504964118, 3069405656, 3058768728, 724116929, 917984056, 3169345062, 2160683478, 2777178327, 2480568374, 4062491294, 2173018032, 518299122, 1932770099, 4222830695, 3061811096, 355555852, 2120226392, 1020009696, 4015067311, 3254625549, 2348089357, 1390203970, 2169174912, 3315411847, 469984267, 269019260, 4102724194, 485872599, 3748229822, 2136391795, 4288940890, 1965072554, 3217529454, 3348114936, 3440396115, 391670555, 45788503, 4157185974, 1131835922, 1506683461, 2674965948, 2519404323, 707000780, 3950515980, 855724843, 3755097121, 2144813657, 2007179338, 3546059874, 155445525, 2407733366, 2824311317, 2915600193, 3798214222, 645580220, 168368788, 2916540740, 1714791902, 1164183266, 3096183917, 2723747763, 1061638818, 1193708765, 524263969, 692661237, 2331303124, 1436325897, 3133785000, 3562754641, 2731760019, 1043540652, 3121608622, 2596482521, 1461269925, 3947006397, 4038208669, 952513805, 2782593580, 1520413302, 1120600729, 3679050952, 1610979743, 1296469334, 2780871944, 1477634104, 2366920741, 93017542, 541136831, 1140038273, 3705684449, 1749408837, 405023983, 1083696753, 460470045, 3758941550, 358522887, 807420897, 926568237, 895845485, 984078324, 221316490, 1645166125, 1683647090, 541103136, 3273178445, 1948007111, 4193522238, 2300015427, 3646871716, 2603994158, 1930565722, 1391625476, 3290897432, 1919372167, 1831098501, 4291923594, 38469601, 501886051, 33257807, 4103619721, 418647981, 2105023938, 2123771552, 4144746559, 1328278527, 1089508634, 426489908, 389980092, 3958972194, 2637407620, 3459214638, 1959090251, 3368365088, 266511238, 1283841181, 3218930184, 3415834892, 3710363084, 998754676, 3005503544, 960154906, 49844427, 1436930213, 3708824379, 2273024689, 2837430393, 2466302739, 2408377801, 898251560, 3038989730, 3050106971, 73327711, 3001368234, 642473556, 3653926152, 2799351601, 440579552, 603982281, 1822649415, 3582912499, 1988233436, 2537569040, 3229993368, 2102522289, 920182553, 330142624, 768799625, 3354680198, 107527400, 1301603297, 3185827495, 308114433, 2246162375, 1687623141, 2029889021, 2687405597, 733153703, 147302511, 59820262, 327300841, 3497233670, 3736974241, 1281640686, 3275636973, 1219457204, 3947430897, 1182598905, 1728869290, 742438257, 1743757156, 203376510, 2345419754, 4205757055, 1083928768, 3810103995, 609703142, 3052403645, 1321077782, 3680253998, 3334623358, 3249285574, 528088362, 197763450, 3524001553, 2093367528, 3755725381, 723028484, 2322573644, 1024385775, 2997530233, 641362142, 1389995156, 1115833732, 3625702752, 2481418855, 1498257485, 1223228909, 196109222, 3746171970, 1225970453, 1406952473, 1968402765, 1367277457, 819541099, 1409980151, 2476712517, 872485681, 2059607952, 2362334213, 2712495394, 3816226098, 849927916, 119680343, 2376397521, 4178293906, 3084557073, 3767971041, 593208776, 3651521574, 2305946618, 3512623115, 77552340, 2813084142, 1679950757, 438025897, 3236853935, 1986319866, 1474324820, 2351800530, 351738287, 1111979753, 4274694464, 2309026601, 3622424902, 1201066363, 2485326224, 386768242, 3077626144, 3893400303, 2626970668, 4007951389, 3280561147, 2567463260, 1438562648, 2947760903, 1096872913, 1674381483, 3963007165, 130478318, 3316879182, 2728838884, 1887689294, 2807362078, 3688068106, 257299908, 3338267735, 1346636323, 673200918, 2764400249, 1783136819, 603596179, 4276595790, 2639745875, 3310874606, 443823470, 429449426, 2895360590, 4043325451, 1545799556, 2335472975, 3809549384, 3791093977, 3131295707, 3030654256, 666555908, 120739885, 2278750234, 935858327, 1500476043, 2027508220, 2719820235, 1224219659, 544557041, 3104157475, 2375231240, 606181213, 452681163, 1929733780, 342814085, 2059890986, 1833306724, 4040575745, 4165518139, 4136468769, 362707627, 2558760513, 3604479814, 2449498316, 2319371788, 186330664, 1059517726, 1862785148, 282065602, 2456355512, 2021940496, 4204332945, 3875668127, 1801539940, 3498022154, 3886415715, 3159461139, 3283136313, 45738249, 102835043, 1431227634, 2563862328, 3606921761, 374154427, 2937206317, 1583318110, 1036597982, 3478395704, 1063338356, 1859744049, 219200221, 3793190033, 1493059304, 2199789834, 4185419020, 3985972012, 2336388680, 2859911953, 4101990, 78699987, 2540294907, 2296885363, 434348662, 6807583, 3668386856, 686596884, 4062499926, 3570567193, 703636630, 128007451, 1820409913, 2343060194, 1966057810, 236018183, 957309793, 4064209960, 2674514186]
a = [2029505402, 2730067469, 1130356704, 3288337153, 2004025140, 1686393387, 1710691259, 3450096250, 3196313339, 2567142936, 3866755093, 3730698564, 3988304911, 1138588203, 811200611, 2717102259, 4101813786, 1838281938, 3896318095, 3330898071, 135301511, 1562880867, 1329725908, 1639050863, 2465820254, 234606032, 3667108987, 3613102864, 3822322875, 3606172782, 2733641793, 3623688042, 39770750, 3267633424, 1286057221, 1341283085, 449870790, 3279759988, 1961519832, 931696381, 2990277204, 210675404, 3300248306, 1989530530, 1184606302, 1864851250, 138801251, 3090297409, 1336057265, 550633307, 2638092819, 2773684069, 1765024865, 1792654137, 2604046639, 225086599, 3903944320, 67449250, 3315365723, 3294806718, 2804312288, 776910139, 2490684334, 1625790920, 3369527841, 8705411, 4084326961, 1242286742, 857806604, 3152517706, 1811727499, 3468922275, 2958655031, 2188443315, 3842330310, 3091656930, 3089614552, 1726364421, 2607948049, 1176126356, 1182810477, 448442619, 1665545477, 3205343980, 364092133, 848838547, 3300420890, 3152759510, 2954221309, 905068901, 122393524, 2325168238, 401193664, 1890492871, 1398984667, 3134140208, 2479970579, 2686562552, 2194461151, 2342364049, 3785136527, 2211179179, 3874518940, 2758562308, 3968194922, 3570848568, 3454750042, 4109812116, 2666310583, 269174423, 1940654394, 1357053458, 986600849, 606188480, 1862057396, 1319688960, 3273061200, 2059402440, 62958157, 3874409588, 1934365952, 1401044819, 2123531458, 1596765523, 1695886935, 1732019159, 77692654, 2742136765, 2995896747, 3790434881, 1920475335, 622308525, 303462362, 250746033, 3701189969, 1500215527, 1735958269, 3184315148, 14625544, 2381119949, 1299878143, 1996311891, 2031659312, 1992136736, 1608991565, 2166891355, 3945148444, 3326110292, 1211084058, 1482724524, 78700811, 420939015, 1587820977, 3121427991, 4260791874, 300786832, 1876211162, 659538775, 1685010933, 2589453297, 3327270527, 3565766818, 1018572817, 3979118867, 2718915223, 3006449734, 3158965151, 567923500, 3567372374, 1386755297, 3078860073, 3412209375, 1242823996, 375554213, 3056329503, 3973975200, 802881892, 3187754590, 2143568470, 2626088457, 3411771325, 277899674, 2178753159, 2745301714, 1306109623, 3994365329, 139156055, 1598490280, 1167183738, 3884911838, 1973125331, 2770947559, 4148862690, 445640695, 1332288625, 1524789030, 33304292, 602345313, 1680193865, 3643666628, 661442794, 1320222542, 230022034, 206187215, 891573589, 4239577973, 2876292205, 3344615102, 1920014185, 433713409, 1185861201, 1310284988, 2622146410, 3786014558, 488119314, 2086869504, 1433485399, 2334643888, 2897096589, 1917906142, 2197544441, 99880950, 1841821131, 1707057257, 2770641611, 848249049, 1271830901, 4217714564, 3167510564, 360247661, 399643612, 3107202996, 3595058017, 2500018927, 2952577678, 1916887878, 2408838552, 3425497411, 3386366188, 2556327128, 4273668244, 1402888976, 2186745680, 2843052525, 630630048, 1139624122, 1917590479, 3565464862, 1484747068, 3620739949, 2717447109, 1870739367, 3228454707, 4238001239, 1158327149, 3350345828, 1830180029, 521190123, 4051332409, 1069253951, 2110671823, 4109305865, 2019587089, 1314692542, 2887203958, 3453810399, 1052294423, 2038732589, 406689966, 209676090, 437178094, 3122992657, 379625142, 3396342661, 4278527690, 889806904, 560686759, 2471339257, 1845336632, 1499693241, 795048425, 1901492839, 2488248002, 2648364017, 1784588425, 3628644936, 3667385685, 1036173095, 3338463049, 1506809333, 2599521577, 3738540146, 45648918, 2276848002, 1628948161, 407549976, 167623207, 2422622953, 2798912744, 2506235545, 3654905917, 1420133799, 3568542608, 1333483196, 1893950385, 4280443205, 263828990, 1688605971, 2610569154, 4177609849, 1079136486, 1386319826, 792693907, 2506841830, 583551617, 2207972213, 1423063654, 3794031697, 454512674, 3997159909, 1140270375, 1297667125, 2336091785, 286965124, 2491372615, 3291801983, 1278411580, 936202562, 2369008430, 2164936305, 3121786152, 1116800027, 2890173512, 3037965915, 2182580235, 1810300987, 1567868087, 1427358306, 2408611396, 1356747543, 2698728626, 341818974, 1451375057, 2815422678, 1479860107, 2014968757, 1951015623, 2557868328, 1912943107, 3620227618, 2608700796, 2560173353, 817581689, 536175503, 2168593933, 1474959351, 3726722719, 565527194, 3818424319, 2135275078, 887442724, 3647480425, 64408920, 3713213026, 1400085872, 2115506398, 3724587207, 2660853191, 135018282, 1968106805, 88264507, 2787647565, 666296322, 3458471294, 514701803, 790227715, 3074831225, 294014836, 1353546107, 863172807, 3343386752, 2234425840, 4185751232, 3899939488, 4046891478, 200552674, 2678410071, 2650381294, 1544304912, 1488855128, 935453768, 875407612, 2183320562, 593345015, 2115607286, 1896482308, 932684219, 2773703071, 378380887, 1402527408, 402828716, 1025375182, 2179210660, 271286737, 1531566685, 1682311706, 2497152098, 2306464991, 1353415340, 734594446, 3946230151, 63796800, 2523765733, 118049792, 2061783496, 4212316546, 1648230158, 1755327986, 3689397715, 3293852786, 1456527298, 3328454739, 985724247, 1518322777, 1807909573, 2270478055, 2582955275, 3782948918, 3308705846, 1210110874, 2063052494, 3791482677, 1944089148, 3556963596, 2964383608, 767349244, 2761812407, 1995025573, 344604030, 2298546954, 1081221214, 588116345, 4218387844, 3941252107, 2318985398, 1345270985, 2972452551, 2794793542, 3571608304, 2313116383, 884647241, 2780113561, 2402572626, 2118338676, 1559712485, 1693067242, 340003862, 2084111377, 2718573177, 1941237879, 1180875121, 304924412, 2833914402, 2409288301, 3731229644, 3910059894, 2725178439, 1121809741, 3928657034, 3284757014, 144041319, 810004741, 3537935714, 2250028200, 427361572, 1830889765, 2380860116, 1412449137, 2525659604, 1540966923, 453922738, 3518218430, 1768305752, 3098484018, 2552334686, 1686230349, 2478058847, 1912277405, 3718851690, 162901633, 1260825905, 1993192575, 1939163179, 1274753476, 216088014, 1621871888, 917339997, 4230278309, 901674138, 1166178375, 1953396102, 2669981687, 3040653602, 3330905615, 3588069126, 1839461461, 793212571, 888535878, 1793967957, 1706317755, 263384358, 3369872089]
f = [172726532595, 626644115741, 639699034095, 505315824361, 372926623247, 517574605128, 185188664643, 151765551359, 246806484646, 313551698318, 366113530275, 546914911952, 246941706000, 157807969353, 36763045564, 110917873937]
m = 738136690439
q = 2**32-5
n = 512
k = 80-16
coe = matrix(ZZ, 17+2*k-1, 17+k-1)

f.append(-1)
for i in range(k):
    for j in range(17):
        coe[i, i+j] = f[j]

for i in range(17+k-1):
    coe[k+i, i] = m

coeff = list(coe.BKZ(block_size=30)[k:k+15])
print("BKZ done")

L = matrix(ZZ, [[1, m],
               [0, q]])
g = L.LLL()[0][0]
    
B  = []
for i in range(512):
    tp = []
    for j in range(512):
        if i+j<512:
            tp.append(a[(511-j-i)%512])
        else:
            tp.append(-a[(511-j-i)%512])
    B.append(tp)


print("brup all char")
m = b'antd3ctf{'
for i in tqdm(range(64-9)):
    check = []
    for item in coeff:
        check.append([0]*(512-16-k-8*i)+list(item)[::-1]+[0]*(8*i))
    for j in range(128):
        diff = matrix(Zmod(q), B[i*8: i*8+80])
        s1_ = list(map(int, list(bin(int(m[-9:].hex(), 16))[2:].rjust(72, '0'))))+list(map(int, list(bin(j)[2:].rjust(8, '0'))))
        b_ = vector(Zmod(q), b[::-1])-vector(Zmod(q), s1_)*diff
        cal = 0
        for _ in range(15):
            t = vector(Zmod(q), check[_])
            if int(g*b_*t)<2^28 or int(q-g*b_*t)<2^28:
                cal += 1
        if cal>8:
            print(bytes([j]))
            m += bytes([j])
            break
            
print(m)
```

